---
title: "DSCI5340"
output:
  pdf_document: default
  html_document:
    df_print: paged
date: "2022-10-10"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
pacman :: p_load(fpp3,tsibbledata, dplyr,xts, lubridate, ggplot2,tibble,tsibble,GGally, gridExtra)
theme_set(theme_classic())
```


1. Produce a time plot of the data and describe the patterns. Identify any unusual or unexpected fluctuations in the time series.
```{r}
glimpse(insurance)
```
```{r}
insurance %>%
  pivot_longer(c(Quotes, TVadverts), names_to="Series") %>%
  autoplot(value, lwd = 0.75) + 
  labs(y="Changes in Quotes and TVadverts",
       title = "Quotes and TV advertisment expenditure")
```

When compared to the Quatations from January 2002 to April 2005 the data has been changing for month to month on TV advertisement expenditures.In given time period the  TV advertisements are less than the actual expected quote price. We can observe the pattern of the plot from the data where TV advertisement prices are very high in starting months of the year and gradually decreases in the middle of the year and then raises eventually at the end of the year.


2. Fit a regression model with Quotes as the dependent variable and a linear trend and seasonal dummies as explanatory variables.
```{r}
insurance %>%
  ggplot(aes(x = Quotes , y = TVadverts)) + 
  geom_point() + 
  geom_smooth(method = "lm", se = FALSE) +
  labs(y = "TVadverts",
       x = "Quotes")


```
```{r}
ins_fit <- insurance %>%
  model(TSLM(Quotes ~ trend() + season())) %>%
  report()

```

3. Create a plot showing two lines – a fitted line from the above regression and a line with actual quotes. What do you observe in this plot?
```{r}
augment(ins_fit) %>%
  ggplot(aes(x = Month)) +
  geom_line(aes(y = Quotes, colour = "Data"),lwd = 0.75) +
  geom_line(aes(y = .fitted, colour = "Fitted"),lwd = 0.75) +
  scale_colour_manual(
    values = c(Data = "orange", Fitted = "black")
  ) +
  labs(y = "Quotes",
       title = "Quotes- Fitted V Actual") +
  guides(colour = guide_legend(title = "Series"))

```


The red line represents the actual Quotes data, while the black line represents the fitted values, with the simply expected values using the equation allover the given time period. By observing the graphical representation of Real and Fitted values, We conclude that the fitted values do not match the actual data and also different from the original data.


4. Create a scatter plot showing fitted v actual. Do you observe any patterns?
```{r}
augment(ins_fit) %>%
  ggplot(aes(x = .fitted, y = Quotes,
             colour = factor(quarter(Month)))) +
  geom_point() +
  labs(y = "Fitted Values", x = "Actual values",
       title = "Scatterplot for Fitted v Actual") +
  geom_abline(intercept = 0, slope = 1) +
  guides(colour = guide_legend(title = "QUARTER"))

```

The fitted values and anticipated values are represented by line and dots respectively in each quarter.If we know the percentage change then we can find both the fitted and actual data. We can observe the data that there are equal number of observations lie above and below the line and few of them are on the line. This scatter plot says that the fitted and real values have a positive correlation.


5. Plot the residuals against time and against the fitted values. Do these plots reveal any autocorrelation in the model?
  
```{r}
ins_fit %>% gg_tsresiduals()
```

Both the plots of residuals and time with gg tsresiduals() function says the mean of residuals is zero, the variance is constant, and histogram of residual says that it is normally distributed. By observing the ACF plot we can see one line is outside the blue dotted lines(95% confidence boundaries), this indicates that there is no auto-correlation. This says that the residuals contain White Noise. Hence there is no more information to extract.

```{r}
model <-lm(TVadverts ~ Quotes, data= insurance)
summary(model)


fitted.values(model)

```
```{r}
ins_fit_value <- insurance
ins_fit_value$predicted <- fitted.values(model)
ins_fit_value
```
```{r}
ins_res_value <- ins_fit_value
ins_res_value$residuals <- residuals(model)
ins_res_value
```
```{r}
qplot(fitted.values(model),residuals(model))+geom_smooth(method="lm",se=F)
```


6. Generate box plots of the residuals for each month. Do these plots reveal any patterns in the above model?
  
```{r}
res_box_plot <- resid(ins_fit)
res_box_plot.month <- data.frame(res_box_plot$.resid, month=rep(1:10,4))
boxplot(res_box_plot$.resid ~ month, data=res_box_plot.month)
```
This requires us to take more information as the boxplots show few more extensive fluctuiations in few months.


7. Run a Ljung-Box test and interpret the results.

```{r}
augment(ins_fit)%>% features(.innov, ljung_box, lag=10, dof=5)
```
 We can see the P-value is greater than 0.05, so the Null hypothesis is satisfied, the residuals are not autocorrelated. Thus the residuals contain White Noise.


8.Interpret the coefficients – the one associated with the trend variable and at least one associated with a seasonal variable.
```{r}
ins_fit <- insurance %>%
  model(TSLM(Quotes ~ trend() + season()))
report(ins_fit)
```

The model has a negative trend based on the established coefficients, and when it comes to seasonality coefficients, the coefficient value of season from year 2 reveals that insurance quotes and advertising spending are 1.47572 more in the second month than the first. The coefficient for the third month shows that insurance quotes and advertising expenditures were 0.54569 less than they were for the first month.


9. Use your regression model to forecast the monthly Quotes for 36 months ahead. Produce prediction intervals for those forecasts
```{r}
ins_fit %>% forecast(month=36)%>% autoplot(insurance)
```

The lighter purple indicates a prediction level of 95%, while the darker purple indicates a prediction level of 80%.


10. Do you have any recommendations for improving the model?
  
Given that the data still indicates that there are substantial fluctuations related to seasonality, I think this model does an efficient job of reflecting and forecasting insurance quotes. As we know there is some autocorrelation remaining in the residuals, So the information remaining in the residuals can be exploited to obtain better forecasts; may be a dynamic-regression model is better for this data as the forecasts from the current model are unbiased, but will have larger prediction intervals than they need to.